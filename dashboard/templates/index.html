<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Onion Warehouse Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for dynamic graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Configure Tailwind to use the Inter font and a custom accent color -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-orange': '#F97316', // Light Orange accent color from sketch
                        'alert-red': '#EF4444',
                        'warning-yellow': '#FBBF24',
                        'ideal-green': '#10B981',
                        'bg-dark': '#0F172A',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #94A3B8;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header / Top Bar: Retained Max-Width for cleaner navigation -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <!-- This div keeps the header content centered and readable -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <!-- Title and Status Bar -->
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-extrabold text-gray-900" id="app-title-container">
                    <span id="app-title" data-translate-key="app_title">Onion</span> <span class="text-primary-orange" data-translate-key="warehouse_title">Warehouses</span>
                </h1>
                <!-- Overall Status Indicator -->
                <div id="overall-status-bar" class="flex items-center p-2 rounded-full text-xs font-semibold">
                    <div id="status-dot" class="w-2 h-2 rounded-full mr-2"></div>
                    <span id="status-text" data-translate-key="status_operational">Operational</span>
                </div>
            </div>

            <!-- Language and Menu -->
            <div class="flex items-center space-x-4">
                <!-- Language Dropdown -->
                <div class="relative">
                    <select id="language-select" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-lg text-sm transition duration-150 ease-in-out cursor-pointer focus:ring-2 focus:ring-primary-orange">
                        <option value="en" data-translate-key="language_en">üåê Language: English</option>
                        <option value="hi" data-translate-key="language_hi">üåê Language: Hindi</option>
                        <option value="es" data-translate-key="language_es">üåê Language: Spanish</option>
                    </select>
                </div>
                <!-- Menu Button -->
                <button class="text-gray-600 hover:text-primary-orange p-2 rounded-lg transition duration-150 ease-in-out">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area: Now spans full width (w-full) for the "full window screen" effect -->
    <main class="flex-grow w-full px-4 sm:px-6 lg:px-8 py-8">
        <!-- Main Grid: 60% (3 columns) / 40% (2 columns) -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <!-- Left Columns (60% - col-span-3): Paired Status & Graphs (Vertical Stack) -->
            <div class="lg:col-span-3 space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="monitoring-header" data-translate-key="monitoring_header">Real-time Monitoring & Trends</h2>
                
                <!-- Group 1: Temperature Status and Graph -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <!-- Temp Tile (Condensed View) -->
                    <div id="temp-card" class="status-card p-4 rounded-xl shadow-inner transition duration-300 mb-4">
                        <h3 class="text-md font-semibold text-gray-700 mb-1" id="temp-status-header" data-translate-key="temp_status_header">Temperature Status</h3>
                        <div class="flex justify-between items-center">
                            <p id="temp-value" class="text-4xl font-extrabold text-gray-900">-- ¬∞C</p>
                            <p id="temp-alert" class="text-sm font-medium transition-all text-right" data-translate-key="loading_data">Loading data...</p>
                        </div>
                    </div>
                    <!-- Temp Graph -->
                    <h3 class="font-bold mb-2 text-gray-800 border-t pt-4 mt-4" id="temp-trend-header" data-translate-key="temp_trend_header">Temperature Trend (¬∞C)</h3>
                    <canvas id="tempChart"></canvas>
                </div>

                <!-- Group 2: Humidity Status and Graph -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <!-- Humidity Tile (Condensed View) -->
                    <div id="humid-card" class="status-card p-4 rounded-xl shadow-inner transition duration-300 mb-4">
                        <h3 class="text-md font-semibold text-gray-700 mb-1" id="humid-status-header" data-translate-key="humid_status_header">Humidity Status</h3>
                        <div class="flex justify-between items-center">
                            <p id="humid-value" class="text-4xl font-extrabold text-gray-900">-- %</p>
                            <p id="humid-alert" class="text-sm font-medium transition-all text-right" data-translate-key="loading_data">Loading data...</p>
                        </div>
                    </div>
                    <!-- Humidity Graph -->
                    <h3 class="font-bold mb-2 text-gray-800 border-t pt-4 mt-4" id="humid-trend-header" data-translate-key="humid_trend_header">Humidity Trend (%)</h3>
                    <canvas id="humidChart"></canvas>
                </div>

                <!-- Group 3: Air Quality Status and Graph -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <!-- Air Quality Tile (Condensed View) -->
                    <div id="airq-card" class="status-card p-4 rounded-xl shadow-inner transition duration-300 mb-4">
                        <h3 class="text-md font-semibold text-gray-700 mb-1" id="airq-status-header" data-translate-key="airq_status_header">Air Quality Status</h3>
                        <div class="flex justify-between items-center">
                            <p id="airq-value" class="text-4xl font-extrabold text-gray-900">-- PPM</p>
                            <p id="airq-alert" class="text-sm font-medium transition-all text-right" data-translate-key="loading_data">Loading data...</p>
                        </div>
                    </div>
                    <!-- Air Quality Graph -->
                    <h3 class="font-bold mb-2 text-gray-800 border-t pt-4 mt-4" id="airq-trend-header" data-translate-key="airq_trend_header">Air Quality Trend (PPM)</h3>
                    <canvas id="airqChart"></canvas>
                </div>

            </div>

            <!-- Right Column (40% - col-span-2): Actuator Controls Panel & LLM Analysis -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Actuator Control Panel -->
                <section>
                    <h2 class="text-2xl font-bold mb-4 text-primary-orange" id="actuator-header" data-translate-key="actuator_header">Actuator Control Panel</h2>
                    
                    <!-- Horizontal Actuator Layout (3 panels side-by-side) -->
                    <div class="bg-white p-4 rounded-xl shadow-2xl grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4">
                        
                        <!-- Actuator 1: Ventilation Fan -->
                        <div class="p-4 rounded-xl border border-gray-100 flex flex-col items-center text-center shadow-sm hover:shadow-md transition duration-200">
                            <h3 class="font-semibold text-gray-800 mb-2" id="fan-label" data-translate-key="fan_label">Ventilation Fan</h3>
                            <p class="text-sm text-gray-500 mb-4"><span data-translate-key="status_label">Status:</span> <span id="fan-status">OFF</span></p>
                            <button id="fan-btn" onclick="toggleActuator('fan', 'fan-status', this)" class="actuator-btn bg-primary-orange hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105 w-full" data-translate-key="button_on">
                                ON
                            </button>
                        </div>
                        
                        <!-- Actuator 2: Climate Control Unit -->
                        <div class="p-4 rounded-xl border border-gray-100 flex flex-col items-center text-center shadow-sm hover:shadow-md transition duration-200">
                            <h3 class="font-semibold text-gray-800 mb-2" id="climate-label" data-translate-key="climate_label">Climate Control Unit</h3>
                            <p class="text-sm text-gray-500 mb-4"><span data-translate-key="status_label">Status:</span> <span id="climate-status">Idle</span></p>
                            <button id="climate-btn" onclick="toggleActuator('climate', 'climate-status', this)" class="actuator-btn bg-primary-orange hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105 w-full" data-translate-key="button_activate">
                                ACTIVATE
                            </button>
                        </div>

                        <!-- Actuator 3: Sprinkler System (Updated from Dehumidifier) -->
                        <div class="p-4 rounded-xl border border-gray-100 flex flex-col items-center text-center shadow-sm hover:shadow-md transition duration-200">
                            <h3 class="font-semibold text-gray-800 mb-2" id="sprinkler-label" data-translate-key="sprinkler_label">Sprinkler System</h3>
                            <p class="text-sm text-gray-500 mb-4"><span data-translate-key="status_label">Status:</span> <span id="sprinkler-status">OFF</span></p>
                            <button id="sprinkler-btn" onclick="toggleActuator('sprinkler', 'sprinkler-status', this)" class="actuator-btn bg-primary-orange hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105 w-full" data-translate-key="button_on">
                                ON
                            </button>
                        </div>
                    </div>
                </section>

                <!-- LLM Feature: Intelligent Action Recommendation -->
                <section class="mt-8">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800" id="analysis-header" data-translate-key="analysis_header">Intelligent Analysis</h2>
                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-blue-200">
                        <h3 class="font-semibold text-lg mb-4 text-gray-700 flex items-center space-x-2">
                            <span class="text-xl">‚ú®</span> <span id="recommendation-title" data-translate-key="recommendation_title">Optimal Action Recommendation</span>
                        </h3>
                        <button id="recommendation-btn" onclick="getRecommendation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01]" data-translate-key="recommendation_btn_analyze">
                            Analyze Current Conditions & Recommend Fix
                        </button>

                        <div id="recommendation-output" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px] text-gray-600 text-sm whitespace-pre-wrap" data-translate-key="recommendation_initial_text">
                            Click the button above to receive a risk assessment and a 3-step actuator action plan based on the latest sensor data.
                        </div>

                        <!-- Loading indicator -->
                        <div id="loading-indicator" class="hidden mt-4 text-center text-blue-600 font-semibold flex items-center justify-center space-x-2">
                            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span data-translate-key="loading_text">Analyzing with Gemini... Please wait.</span>
                        </div>
                    </div>
                </section>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-bg-dark text-white p-4 mt-8">
        <div class="max-w-7xl mx-auto flex justify-between items-center text-sm">
            <p data-translate-key="footer_copyright">&copy; 2024 Onion Warehouse Management</p>
            <div>
                <a href="#about-team" class="text-primary-orange hover:text-orange-300 font-semibold transition duration-150 ease-in-out" data-translate-key="footer_by_team">
                    By Team Soteria
                </a>
                <span class="mx-2 text-gray-500">|</span>
                <a href="#" class="text-gray-400 hover:text-white transition duration-150 ease-in-out" data-translate-key="footer_about">
                    About
                </a>
            </div>
        </div>
    </footer>


    <script type="module">
        // --- Firebase/Authentication Setup (MANDATORY STRUCTURE) ---
        // These variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let auth = null;
        let userId = 'mock-user-id'; // Use mock ID for simplicity
        let currentLanguage = 'en';

        // --- Translation Data ---
        const TEXT_KEYS = {
            // Header & Status
            'app_title': { 'en': 'Onion', 'hi': '‡§™‡•ç‡§Ø‡§æ‡§ú', 'es': 'Cebolla' },
            'warehouse_title': { 'en': 'Warehouses', 'hi': '‡§≠‡§Ç‡§°‡§æ‡§∞ ‡§ó‡•É‡§π', 'es': 'Almacenes' },
            'status_operational': { 'en': 'Operational', 'hi': '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∂‡•Ä‡§≤', 'es': 'Operativo' },
            'status_warning': { 'en': 'Warning Status', 'hi': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø', 'es': 'Estado de Advertencia' },
            'status_critical': { 'en': 'CRITICAL ALERT', 'hi': '‡§Ö‡§§‡§ø ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', 'es': 'ALERTA CR√çTICA' },
            'language_en': { 'en': 'üåê Language: English', 'hi': 'üåê ‡§≠‡§æ‡§∑‡§æ: ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä', 'es': 'üåê Idioma: Ingl√©s' },
            'language_hi': { 'en': 'üåê Language: Hindi', 'hi': 'üåê ‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä', 'es': 'üåê Idioma: Hindi' },
            'language_es': { 'en': 'üåê Language: Spanish', 'hi': 'üåê ‡§≠‡§æ‡§∑‡§æ: ‡§∏‡•ç‡§™‡•à‡§®‡§ø‡§∂', 'es': 'üåê Idioma: Espa√±ol' },

            // Monitoring
            'monitoring_header': { 'en': 'Real-time Monitoring & Trends', 'hi': '‡§∞‡•Ä‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§î‡§∞ ‡§∞‡•Å‡§ù‡§æ‡§®', 'es': 'Monitoreo y Tendencias en Tiempo Real' },
            'loading_data': { 'en': 'Loading data...', 'hi': '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'es': 'Cargando datos...' },
            'temp_status_header': { 'en': 'Temperature Status', 'hi': '‡§§‡§æ‡§™‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø', 'es': 'Estado de Temperatura' },
            'humid_status_header': { 'en': 'Humidity Status', 'hi': '‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø', 'es': 'Estado de Humedad' },
            'airq_status_header': { 'en': 'Air Quality Status', 'hi': '‡§µ‡§æ‡§Ø‡•Å ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø', 'es': 'Estado de Calidad del Aire' },
            'temp_trend_header': { 'en': 'Temperature Trend (¬∞C)', 'hi': '‡§§‡§æ‡§™‡§Æ‡§æ‡§® ‡§∞‡•Å‡§ù‡§æ‡§® (¬∞C)', 'es': 'Tendencia de Temperatura (¬∞C)' },
            'humid_trend_header': { 'en': 'Humidity Trend (%)', 'hi': '‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ ‡§∞‡•Å‡§ù‡§æ‡§® (%)', 'es': 'Tendencia de Humedad (%)' },
            'airq_trend_header': { 'en': 'Air Quality Trend (PPM)', 'hi': '‡§µ‡§æ‡§Ø‡•Å ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§∞‡•Å‡§ù‡§æ‡§® (PPM)', 'es': 'Tendencia de Calidad del Aire (PPM)' },

            // Status Messages (used in updateStatusTiles)
            'status_ideal_stable': { 'en': 'IDEAL: Stable', 'hi': '‡§Ü‡§¶‡§∞‡•ç‡§∂: ‡§∏‡•ç‡§•‡§ø‡§∞', 'es': 'IDEAL: Estable' },
            'status_near_limit': { 'en': 'WARNING: Near Limit', 'hi': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§∏‡•Ä‡§Æ‡§æ ‡§ï‡•á ‡§™‡§æ‡§∏', 'es': 'ADVERTENCIA: Cerca del L√≠mite' },
            'status_extreme_condition': { 'en': 'CRITICAL: Extreme Condition', 'hi': '‡§Ö‡§§‡§ø ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£: ‡§ö‡§∞‡§Æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø', 'es': 'CR√çTICO: Condici√≥n Extrema' },
            'status_elevated_levels': { 'en': 'WARNING: Elevated Levels', 'hi': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§ä‡§Ç‡§ö‡•á ‡§∏‡•ç‡§§‡§∞', 'es': 'ADVERTENCIA: Niveles Elevados' },
            'status_high_contamination': { 'en': 'CRITICAL: High Contamination', 'hi': '‡§Ö‡§§‡§ø ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£: ‡§â‡§ö‡•ç‡§ö ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£', 'es': 'CR√çTICO: Alta Contaminaci√≥n' },

            // Actuators
            'actuator_header': { 'en': 'Actuator Control Panel', 'hi': '‡§Ö‡§≠‡§ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§™‡•à‡§®‡§≤', 'es': 'Panel de Control del Actuador' },
            'status_label': { 'en': 'Status:', 'hi': '‡§∏‡•ç‡§•‡§ø‡§§‡§ø:', 'es': 'Estado:' },
            'fan_label': { 'en': 'Ventilation Fan', 'hi': '‡§µ‡•á‡§Ç‡§ü‡§ø‡§≤‡•á‡§∂‡§® ‡§™‡§Ç‡§ñ‡§æ', 'es': 'Ventilador de Ventilaci√≥n' },
            'climate_label': { 'en': 'Climate Control Unit', 'hi': '‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§á‡§ï‡§æ‡§à', 'es': 'Unidad de Control Clim√°tico' },
            'sprinkler_label': { 'en': 'Sprinkler System', 'hi': '‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä', 'es': 'Sistema de Rociadores' },
            
            // Actuator Buttons
            'button_on': { 'en': 'ON', 'hi': '‡§ö‡§æ‡§≤‡•Ç', 'es': 'ENCENDER' },
            'button_off': { 'en': 'OFF', 'hi': '‡§¨‡§Ç‡§¶', 'es': 'APAGAR' },
            'button_activate': { 'en': 'ACTIVATE', 'hi': '‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç', 'es': 'ACTIVAR' },
            'button_shutdown': { 'en': 'SHUTDOWN', 'hi': '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç', 'es': 'APAGAR' },

            // Actuator Status (for actuator status spans)
            'status_active': { 'en': 'ACTIVE', 'hi': '‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø', 'es': 'ACTIVO' },
            'status_spraying': { 'en': 'SPRAYING', 'hi': '‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à', 'es': 'ROCIANDO' },
            'status_idle': { 'en': 'Idle', 'hi': '‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø', 'es': 'Inactivo' },
            'status_off': { 'en': 'OFF', 'hi': '‡§¨‡§Ç‡§¶', 'es': 'APAGADO' },
            'status_cooling': { 'en': 'Cooling (24/7)', 'hi': '‡§∂‡•Ä‡§§‡§≤‡§® (24/7)', 'es': 'Enfriando (24/7)' },

            // Actuator Messages (used in showNotification)
            'msg_fan_on': { 'en': 'Ventilation Fan turned ON.', 'hi': '‡§µ‡•á‡§Ç‡§ü‡§ø‡§≤‡•á‡§∂‡§® ‡§™‡§Ç‡§ñ‡§æ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'es': 'Ventilador de Ventilaci√≥n encendido.' },
            'msg_fan_off': { 'en': 'Ventilation Fan turned OFF.', 'hi': '‡§µ‡•á‡§Ç‡§ü‡§ø‡§≤‡•á‡§∂‡§® ‡§™‡§Ç‡§ñ‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'es': 'Ventilador de Ventilaci√≥n apagado.' },
            'msg_climate_on': { 'en': 'Climate Control Unit ACTIVATED.', 'hi': '‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§á‡§ï‡§æ‡§à ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡•Ä ‡§ó‡§à‡•§', 'es': 'Unidad de Control Clim√°tico ACTIVADA.' },
            'msg_climate_off': { 'en': 'Climate Control Unit SHUT DOWN.', 'hi': '‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§á‡§ï‡§æ‡§à ‡§¨‡§Ç‡§¶ ‡§ï‡•Ä ‡§ó‡§à‡•§', 'es': 'Unidad de Control Clim√°tico APAGADA.' },
            'msg_sprinkler_on': { 'en': 'Sprinkler System turned ON.', 'hi': '‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡•Ä ‡§ó‡§à‡•§', 'es': 'Sistema de Rociadores encendido.' },
            'msg_sprinkler_off': { 'en': 'Sprinkler System turned OFF.', 'hi': '‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§¨‡§Ç‡§¶ ‡§ï‡•Ä ‡§ó‡§à‡•§', 'es': 'Sistema de Rociadores apagado.' },

            // LLM Analysis
            'analysis_header': { 'en': 'Intelligent Analysis', 'hi': '‡§¨‡•Å‡§¶‡•ç‡§ß‡§ø‡§Æ‡§æ‡§® ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£', 'es': 'An√°lisis Inteligente' },
            'recommendation_title': { 'en': 'Optimal Action Recommendation', 'hi': '‡§á‡§∑‡•ç‡§ü‡§§‡§Æ ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§æ', 'es': 'Recomendaci√≥n de Acci√≥n √ìptima' },
            'recommendation_btn_analyze': { 'en': 'Analyze Current Conditions & Recommend Fix', 'hi': '‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§∏‡•Å‡§ù‡§æ‡§è‡§Ç', 'es': 'Analizar Condiciones Actuales y Recomendar Soluci√≥n' },
            'recommendation_btn_analyzing': { 'en': 'Analyzing...', 'hi': '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'es': 'Analizando...' },
            'recommendation_initial_text': { 'en': 'Click the button above to receive a risk assessment and a 3-step actuator action plan based on the latest sensor data.', 'hi': '‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§∏‡•á‡§Ç‡§∏‡§∞ ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§î‡§∞ 3-‡§ö‡§∞‡§£‡•Ä‡§Ø ‡§Ö‡§≠‡§ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', 'es': 'Haga clic en el bot√≥n de arriba para recibir una evaluaci√≥n de riesgos y un plan de acci√≥n de 3 pasos basado en los √∫ltimos datos del sensor.' },
            'loading_text': { 'en': 'Analyzing with Gemini... Please wait.', 'hi': '‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§• ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§', 'es': 'Analizando con Gemini... Por favor espere.' },
            'running_simulation': { 'en': 'Running advanced simulation...', 'hi': '‡§â‡§®‡•ç‡§®‡§§ ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§∂‡§® ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à...', 'es': 'Ejecutando simulaci√≥n avanzada...' },

            // Footer
            'footer_copyright': { 'en': '¬© 2024 Onion Warehouse Management', 'hi': '¬© 2024 ‡§™‡•ç‡§Ø‡§æ‡§ú ‡§≠‡§Ç‡§°‡§æ‡§∞ ‡§ó‡•É‡§π ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®', 'es': '¬© 2024 Gesti√≥n de Almacenes de Cebolla' },
            'footer_by_team': { 'en': 'By Team Soteria', 'hi': '‡§ü‡•Ä‡§Æ ‡§∏‡•ã‡§ü‡§∞‡§ø‡§Ø‡§æ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ', 'es': 'Por Equipo Soteria' },
            'footer_about': { 'en': 'About', 'hi': '‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç', 'es': 'Acerca de' },
        };

        // Function to look up and return the translated string
        function t(key) {
            return TEXT_KEYS[key] ? (TEXT_KEYS[key][currentLanguage] || TEXT_KEYS[key]['en']) : key;
        }

        // --- Translation Logic ---
        function translatePage(lang) {
            currentLanguage = lang;
            
            // 1. Translate all elements with data-translate-key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const translation = t(key);

                if (element.tagName === 'OPTION') {
                    // Handle language dropdown options
                    element.textContent = translation;
                } else {
                    element.textContent = translation;
                }
            });

            // 2. Special case: Actuator button labels need to be translated based on their current state (ON/OFF)
            translateActuatorButtons();
            
            // 3. Update all dynamic status messages (to catch the current state)
            updateStatusTiles(false); // Update with translated texts, don't run simulation

            // 4. Update the document title
            document.title = t('app_title') + ' ' + t('warehouse_title');
        }
        
        function translateActuatorButtons() {
            // Fan Button
            const fanBtn = document.getElementById('fan-btn');
            fanBtn.textContent = fanBtn.classList.contains('bg-gray-400') ? t('button_off') : t('button_on');

            // Climate Button
            const climateBtn = document.getElementById('climate-btn');
            climateBtn.textContent = climateBtn.classList.contains('bg-red-500') ? t('button_shutdown') : t('button_activate');

            // Sprinkler Button
            const sprinklerBtn = document.getElementById('sprinkler-btn');
            sprinklerBtn.textContent = sprinklerBtn.classList.contains('bg-gray-400') ? t('button_off') : t('button_on');
        }
        
        function initializeAppAndAuth() {
            // For a production app, you would initialize Firebase here.
            // Since this is a frontend mock, we proceed with mock data/auth.
            
            // Set initial language from dropdown (default to 'en')
            const langSelect = document.getElementById('language-select');
            currentLanguage = langSelect.value;
            langSelect.addEventListener('change', (e) => translatePage(e.target.value));

            // Initial translation and start dashboard
            translatePage(currentLanguage);
            startDashboard();
        }
        
        // --- Gemini API Utilities ---
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; // Canvas provides this dynamically

        async function geminiApiCall(userQuery, systemPrompt, maxRetries = 3) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 
                                     "Error: Could not parse Gemini response.";
                        return text;
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Handle rate limiting with exponential backoff
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry the request
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                         console.error("Gemini API call failed after multiple retries:", error);
                         return "An error occurred while contacting the analysis engine. Please try again.";
                    }
                }
            }
            return "Failed to get a response from the analysis engine.";
        }


        // --- Dashboard Logic and Mock Data ---

        // Ideal Range Definitions (used for color-coding)
        const RANGES = {
            temp: { ideal: [5, 15], warning: [0, 5, 15, 20], unit: '¬∞C' }, // Ideal 5-15¬∞C
            humid: { ideal: [65, 75], warning: [55, 65, 75, 85], unit: '%' }, // Ideal 65-75%
            airq: { ideal: [300, 800], warning: [800, 1200], unit: 'PPM' } // Ideal <800 PPM
        };

        // Mock historical data (20 points for 20 hours/readings)
        let mockData = {
            labels: Array.from({ length: 20 }, (_, i) => `${i + 1}h ago`),
            temp: Array.from({ length: 20 }, () => Math.floor(Math.random() * 25) + 5),
            humid: Array.from({ length: 20 }, () => Math.floor(Math.random() * 40) + 50),
            airq: Array.from({ length: 20 }, () => Math.floor(Math.random() * 1500) + 100)
        };
        
        // Get the most recent value for the status tiles
        function getCurrentValue(type) {
            return mockData[type][mockData.labels.length - 1];
        }

        function getStatus(type, value) {
            const range = RANGES[type];
            let status = 'IDEAL';
            let statusTextKey = 'status_ideal_stable';
            let color = '#10B981';

            // Check for Critical (Red)
            if (type === 'airq') {
                if (value > range.warning[1]) { status = 'CRITICAL'; statusTextKey = 'status_high_contamination'; color = '#EF4444'; }
            } else {
                if (value < range.warning[0] || value > range.warning[3]) { status = 'CRITICAL'; statusTextKey = 'status_extreme_condition'; color = '#EF4444'; }
            }

            // Check for Warning (Yellow)
            if (status !== 'CRITICAL') {
                if (type === 'airq') {
                    if (value > range.ideal[1]) { status = 'WARNING'; statusTextKey = 'status_elevated_levels'; color = '#FBBF24'; }
                } else {
                    if (value < range.warning[1] || value > range.warning[2]) { status = 'WARNING'; statusTextKey = 'status_near_limit'; color = '#FBBF24'; }
                }
            }
            
            return { status, text: t(statusTextKey), color };
        }

        // Function to update the status tiles and overall status
        // Pass a boolean to decide if we should update actuator status text (which only needs to happen on translation)
        function updateStatusTiles(runActuatorTranslation = true) {
            let overallStatus = 'ideal';
            const currentConditions = {};

            ['temp', 'humid', 'airq'].forEach(type => {
                const value = getCurrentValue(type);
                const status = getStatus(type, value);
                
                currentConditions[type] = { value, status: status.status, unit: RANGES[type].unit };

                // 1. Update Card Value (Value remains non-translated)
                document.getElementById(`${type}-value`).textContent = `${value} ${RANGES[type].unit}`;

                // 2. Update Card Alert Text and Color
                const card = document.getElementById(`${type}-card`);
                const alertText = document.getElementById(`${type}-alert`);
                
                // Reset card classes
                card.className = 'status-card p-4 rounded-xl shadow-inner transition duration-300 mb-4';
                alertText.className = 'text-sm font-medium transition-all text-right';

                // Apply status color and text
                if (status.status === 'CRITICAL') {
                    card.classList.add('bg-alert-red/10', 'ring-4', 'ring-alert-red', 'ring-opacity-50');
                    alertText.classList.add('text-alert-red', 'font-bold');
                    overallStatus = 'critical';
                } else if (status.status === 'WARNING') {
                    card.classList.add('bg-warning-yellow/10', 'ring-4', 'ring-warning-yellow', 'ring-opacity-50');
                    alertText.classList.add('text-warning-yellow');
                    if (overallStatus !== 'critical') overallStatus = 'warning';
                } else {
                    card.classList.add('bg-ideal-green/10', 'ring-4', 'ring-ideal-green', 'ring-opacity-50');
                    alertText.classList.add('text-ideal-green');
                }
                
                alertText.textContent = status.text;
            });

            // Update Actuator Status Text Spans only on translation or initial load
            if (runActuatorTranslation) {
                const fanStatus = document.getElementById('fan-status');
                fanStatus.textContent = fanStatus.textContent === 'OFF' ? t('status_off') : t('status_active');
                
                const climateStatus = document.getElementById('climate-status');
                climateStatus.textContent = climateStatus.textContent.startsWith('Idle') || climateStatus.textContent.includes(t('status_idle')) ? t('status_idle') : t('status_cooling');
                
                const sprinklerStatus = document.getElementById('sprinkler-status');
                sprinklerStatus.textContent = sprinklerStatus.textContent === 'OFF' ? t('status_off') : t('status_spraying');
            }


            // Update Overall Status Bar
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const bar = document.getElementById('overall-status-bar');

            bar.className = 'flex items-center p-2 rounded-full text-xs font-semibold';
            dot.className = 'w-2 h-2 rounded-full mr-2';

            if (overallStatus === 'critical') {
                bar.classList.add('bg-alert-red/20', 'text-alert-red');
                dot.classList.add('bg-alert-red');
                text.textContent = t('status_critical');
            } else if (overallStatus === 'warning') {
                bar.classList.add('bg-warning-yellow/20', 'text-warning-yellow');
                dot.classList.add('bg-warning-yellow');
                text.textContent = t('status_warning');
            } else {
                bar.classList.add('bg-ideal-green/20', 'text-ideal-green');
                dot.classList.add('bg-ideal-green');
                text.textContent = t('status_operational');
            }
            
            return currentConditions; // Return conditions for LLM use
        }

        let charts = {};

        function createChart(type, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const currentValue = getCurrentValue(type);
            const status = getStatus(type, currentValue);
            const label = t(`${type}_label`); // Use a placeholder key since chart labels are complex

            // Define min/max for y-axis scaling
            let minVal, maxVal;
            if (type === 'temp') { minVal = 0; maxVal = 30; }
            else if (type === 'humid') { minVal = 40; maxVal = 100; }
            else { minVal = 0; maxVal = 2000; }

            // Check if the chart already exists, destroy it before creating a new one
            if (charts[type]) {
                charts[type].destroy();
            }

            charts[type] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: mockData.labels,
                    datasets: [{
                        // Keep label in English for simpler Chart.js config, but translate legend if needed (legend is hidden here)
                        label: `${type.charAt(0).toUpperCase() + type.slice(1)} Trend`, 
                        data: mockData[type],
                        borderColor: status.color,
                        backgroundColor: status.color.replace(')', ', 0.1)'), // Light fill
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: status.color,
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            min: minVal,
                            max: maxVal,
                            title: {
                                display: true,
                                text: RANGES[type].unit
                            },
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Tooltip labels remain numeric with units
                                    return `${context.dataset.label}: ${context.parsed.y} ${RANGES[type].unit}`;
                                }
                            }
                        }
                    }
                }
            });
            return charts[type];
        }

        function updateCharts() {
            // Recreate/update charts (createChart now handles destruction internally)
            createChart('temp', 'tempChart');
            createChart('humid', 'humidChart');
            createChart('airq', 'airqChart');
        }

        // --- GEMINI LLM Feature Logic ---
        window.getRecommendation = async function() {
            const outputElement = document.getElementById('recommendation-output');
            const loadingIndicator = document.getElementById('loading-indicator');
            const recommendationBtn = document.getElementById('recommendation-btn');

            // 1. Gather current data
            const conditions = updateStatusTiles(false); // Runs status check and returns data
            const temp = conditions.temp;
            const humid = conditions.humid;
            const airq = conditions.airq;
            
            const conditionString = `
                Temperature: ${temp.value}${temp.unit} (Status: ${temp.status})
                Humidity: ${humid.value}${humid.unit} (Status: ${humid.status})
                Air Quality: ${airq.value}${airq.unit} (Status: ${airq.status})
                The ideal onion storage conditions are: Temp 5-15¬∞C, Humidity 65-75%, Air Quality <800 PPM.
            `.trim();

            // Note: The system prompt specifies the "Sprinkler System"
            // The prompt and system instruction MUST remain in English for the API call.
            const systemPrompt = "You are an expert Agricultural IOT System Analyst focused on long-term onion storage preservation. Your goal is to provide a concise, professional, and actionable 3-step plan to stabilize the warehouse environment using the ventilation fan, climate control unit, and **sprinkler system**. Use bullet points for the plan. Do not include any introductory or concluding remarks, only the analysis and the 3-step plan.";

            const userQuery = `Analyze the following current environmental conditions in the onion storage warehouse and provide a risk assessment and a 3-step action plan for the available actuators (Ventilation Fan, Climate Control Unit, Sprinkler System).

            Current Conditions:
            ${conditionString}
            `;

            // 2. Show loading state
            recommendationBtn.disabled = true;
            recommendationBtn.textContent = t('recommendation_btn_analyzing');
            loadingIndicator.classList.remove('hidden');
            document.querySelector('#loading-indicator span').textContent = t('loading_text');
            outputElement.innerHTML = `<p class="text-center text-gray-500">${t('running_simulation')}</p>`;
            
            // 3. Call the API
            const resultText = await geminiApiCall(userQuery, systemPrompt);

            // 4. Update UI
            loadingIndicator.classList.add('hidden');
            recommendationBtn.disabled = false;
            recommendationBtn.textContent = t('recommendation_btn_analyze');
            
            // Output text is left as-is (API response is in English, or whatever language it determines is best)
            outputElement.textContent = resultText;
        };


        // Mock actuator control
        window.toggleActuator = function(actuatorId, statusId, button) {
            const statusElement = document.getElementById(statusId);
            let messageKey;
            
            if (actuatorId === 'fan' || actuatorId === 'sprinkler') { 
                if (button.textContent === t('button_on')) {
                    // Turn ON
                    button.textContent = t('button_off');
                    button.classList.remove('bg-primary-orange', 'hover:bg-orange-600');
                    button.classList.add('bg-gray-400', 'hover:bg-gray-500');
                    statusElement.textContent = actuatorId === 'sprinkler' ? t('status_spraying') : t('status_active');
                    messageKey = actuatorId === 'sprinkler' ? 'msg_sprinkler_on' : 'msg_fan_on';
                } else {
                    // Turn OFF
                    button.textContent = t('button_on');
                    button.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                    button.classList.add('bg-primary-orange', 'hover:bg-orange-600');
                    statusElement.textContent = t('status_off');
                    messageKey = actuatorId === 'sprinkler' ? 'msg_sprinkler_off' : 'msg_fan_off';
                }
            } else if (actuatorId === 'climate') {
                 if (button.textContent === t('button_activate')) {
                    // Activate
                    button.textContent = t('button_shutdown');
                    button.classList.remove('bg-primary-orange', 'hover:bg-orange-600');
                    button.classList.add('bg-red-500', 'hover:bg-red-600');
                    statusElement.textContent = t('status_cooling');
                    messageKey = 'msg_climate_on';
                } else {
                    // Shutdown
                    button.textContent = t('button_activate');
                    button.classList.remove('bg-red-500', 'hover:bg-red-600');
                    button.classList.add('bg-primary-orange', 'hover:bg-orange-600');
                    statusElement.textContent = t('status_idle');
                    messageKey = 'msg_climate_off';
                }
            }

            // Simple notification modal (uses translated message)
            showNotification(messageKey);
        };

        // Simple Notification/Alert Message Box
        function showNotification(messageKey) {
            let notification = document.getElementById('notification-box');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification-box';
                notification.className = 'fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0';
                document.body.appendChild(notification);
            }
            // Use translation function for the message
            notification.textContent = t(messageKey);
            notification.classList.remove('opacity-0');
            notification.classList.add('opacity-100');
            
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
            }, 3000);
        }

        // Simulation loop to generate new random data and update the UI
        function simulateDataUpdate() {
            // Remove the oldest data point
            mockData.temp.shift();
            mockData.humid.shift();
            mockData.airq.shift();
            
            // Add a new, slightly random data point
            const lastTemp = mockData.temp[mockData.temp.length - 1];
            // Introduce a bias to sometimes push values into "WARNING" or "CRITICAL" for testing
            const randomFactor = Math.random();
            let newTemp;
            if (randomFactor < 0.2) { // 20% chance of a high spike
                newTemp = Math.min(30, lastTemp + (Math.random() * 8 + 1));
            } else {
                newTemp = Math.min(30, Math.max(0, lastTemp + (Math.random() * 6 - 3)));
            }

            mockData.temp.push(Math.round(newTemp));
            
            const lastHumid = mockData.humid[mockData.humid.length - 1];
            const newHumid = Math.min(100, Math.max(40, lastHumid + (Math.random() * 10 - 5)));
            mockData.humid.push(Math.round(newHumid));

            const lastAirQ = mockData.airq[mockData.airq.length - 1];
            const newAirQ = Math.min(2000, Math.max(100, lastAirQ + (Math.random() * 200 - 100)));
            mockData.airq.push(Math.round(newAirQ));

            // Shift the labels to represent a rolling window
            mockData.labels.shift();
            mockData.labels.push('Now');

            // Only update tiles with status text, do not force actuator translation on every simulation cycle
            updateStatusTiles(false); 
            updateCharts();
        }

        function startDashboard() {
            // Initial render
            updateStatusTiles(true); // Initial update, run actuator translation
            updateCharts();

            // Start simulation to update data every 5 seconds
            setInterval(simulateDataUpdate, 5000); 
        }

        // Start the application after the window loads and mock Firebase auth is handled
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>